<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            text-align: center;
            color: #444;
        }

        .auth-buttons {
            text-align: right;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.delete {
            background-color: #dc3545;
        }

        button.delete:hover {
            background-color: #c82333;
        }

        button.edit {
            background-color: #ffc107;
            color: #212529;
        }

        button.edit:hover {
            background-color: #e0a800;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
        }

        #message {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="auth-buttons">
            <span id="userInfo"></span>
            <button onclick="toggleProfile()">Profile</button>
            <button onclick="logout()">Logout</button>
        </div>

        <h1>Calculator Dashboard</h1>

        <div id="profileSection" class="hidden">
            <h2>User Profile</h2>
            <div class="form-group">
                <h3>Update Profile</h3>
                <label for="profileUsername">Username:</label>
                <input type="text" id="profileUsername">
                <label for="profileEmail">Email:</label>
                <input type="email" id="profileEmail">
                <button onclick="updateProfile()">Update Profile</button>
            </div>
            <div class="form-group">
                <h3>Change Password</h3>
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword">
                <button onclick="changePassword()">Change Password</button>
            </div>
            <button onclick="toggleProfile()" style="background-color: #6c757d;">Close Profile</button>
            <div id="profileMessage" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <div id="dashboardSection">
            <div id="addCalculationForm">
                <h2>Add Calculation</h2>
                <div class="form-group">
                    <label for="a">Number A:</label>
                    <input type="number" id="a" required>
                </div>
                <div class="form-group">
                    <label for="b">Number B:</label>
                    <input type="number" id="b" required>
                </div>
                <div class="form-group">
                    <label for="type">Operation:</label>
                    <select id="type">
                        <option value="Add">Add</option>
                        <option value="Subtract">Subtract</option>
                        <option value="Multiply">Multiply</option>
                        <option value="Divide">Divide</option>
                    </select>
                </div>
                <button id="calculateBtn" onclick="addCalculation()">Calculate</button>
                <button id="updateBtn" class="hidden" onclick="submitUpdate()">Update</button>
                <button id="cancelBtn" class="hidden" onclick="cancelEdit()"
                    style="background-color: #6c757d;">Cancel</button>
            </div>

            <div id="message"></div>

            <h2>History</h2>
            <table id="calculationsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>A</th>
                        <th>B</th>
                        <th>Type</th>
                        <th>Result</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Calculations will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
        }

        let currentEditingId = null;

        async function fetchCalculations() {
            const response = await fetch('/calculations', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            if (response.ok) {
                const calculations = await response.json();
                const tbody = document.querySelector('#calculationsTable tbody');
                tbody.innerHTML = '';
                calculations.forEach(calc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${calc.id}</td>
                    <td>${calc.a}</td>
                    <td>${calc.b}</td>
                    <td>${calc.type}</td>
                    <td>${calc.result}</td>
                    <td>
                        <button class="edit" onclick="startEdit(${calc.id}, ${calc.a}, ${calc.b}, '${calc.type}')">Edit</button>
                        <button class="delete" onclick="deleteCalculation(${calc.id})">Delete</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            } else if (response.status === 401) {
                logout();
            }
        }

        async function addCalculation() {
            try {
                const a = document.getElementById('a').value;
                const b = document.getElementById('b').value;
                const type = document.getElementById('type').value;

                const response = await fetch('/calculations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ a: parseInt(a), b: parseInt(b), type: type })
                });

                if (response.ok) {
                    document.getElementById('message').innerText = 'Calculation added successfully!';
                    document.getElementById('message').style.color = 'green';
                    fetchCalculations();
                    clearForm();
                } else {
                    const data = await response.json();
                    document.getElementById('message').innerText = 'Error: ' + (data.error || data.detail);
                    document.getElementById('message').style.color = 'red';
                }
            } catch (error) {
                console.error("Error in addCalculation:", error);
                document.getElementById('message').innerText = 'Error: ' + error.message;
                document.getElementById('message').style.color = 'red';
            }
        }

        async function deleteCalculation(id) {
            if (!confirm('Are you sure you want to delete this calculation?')) return;

            const response = await fetch('/calculations/' + id, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (response.ok) {
                fetchCalculations();
            } else {
                alert('Failed to delete calculation');
            }
        }

        function startEdit(id, a, b, type) {
            currentEditingId = id;
            document.getElementById('a').value = a;
            document.getElementById('b').value = b;
            document.getElementById('type').value = type;

            document.querySelector('button[onclick="addCalculation()"]').classList.add('hidden');
            document.getElementById('updateBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.querySelector('#addCalculationForm h2').innerText = 'Edit Calculation';
        }

        async function submitUpdate() {
            const a = document.getElementById('a').value;
            const b = document.getElementById('b').value;
            const type = document.getElementById('type').value;

            const response = await fetch('/calculations/' + currentEditingId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ a: parseInt(a), b: parseInt(b), type: type })
            });

            if (response.ok) {
                document.getElementById('message').innerText = 'Calculation updated successfully!';
                document.getElementById('message').style.color = 'green';
                fetchCalculations();
                cancelEdit();
            } else {
                const data = await response.json();
                document.getElementById('message').innerText = 'Error: ' + (data.error || data.detail);
                document.getElementById('message').style.color = 'red';
            }
        }

        function cancelEdit() {
            currentEditingId = null;
            clearForm();
            document.querySelector('button[onclick="addCalculation()"]').classList.remove('hidden');
            document.getElementById('updateBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.querySelector('#addCalculationForm h2').innerText = 'Add Calculation';
        }

        function clearForm() {
            document.getElementById('a').value = '';
            document.getElementById('b').value = '';
            document.getElementById('type').value = 'Add';
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }

        // Initial load
        fetchCalculations();
        fetchProfile();

        function toggleProfile() {
            const profileSection = document.getElementById('profileSection');
            const dashboardSection = document.getElementById('dashboardSection');
            if (profileSection.classList.contains('hidden')) {
                profileSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                fetchProfile(); // Refresh data
            } else {
                profileSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                document.getElementById('profileMessage').innerText = '';
            }
        }

        async function fetchProfile() {
            try {
                const response = await fetch('/users/me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('profileUsername').value = user.username;
                    document.getElementById('profileEmail').value = user.email;
                    document.getElementById('userInfo').innerText = 'Logged in as: ' + user.username;
                    document.getElementById('profileMessage').innerText = ''; // Clear fetching message
                } else {
                    const errorText = await response.text();
                    console.error("Failed to fetch profile:", response.status, errorText);
                    document.getElementById('profileMessage').innerText = 'Error fetching profile: ' + response.status;
                    document.getElementById('profileMessage').style.color = 'red';
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
            }
        }

        async function updateProfile() {
            const username = document.getElementById('profileUsername').value;
            const email = document.getElementById('profileEmail').value;

            const body = {};
            if (username) body.username = username;
            if (email) body.email = email;

            const response = await fetch('/users/me', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(body)
            });

            const messageEl = document.getElementById('profileMessage');
            if (response.ok) {
                const user = await response.json();
                messageEl.innerText = 'Profile updated successfully!';
                messageEl.style.color = 'green';
                // Update displayed username if changed
                document.getElementById('userInfo').innerText = 'Logged in as: ' + user.username;
            } else {
                const data = await response.json();
                messageEl.innerText = 'Error: ' + (data.error || data.detail);
                messageEl.style.color = 'red';
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            const response = await fetch('/users/me/password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
            });

            const messageEl = document.getElementById('profileMessage');
            if (response.ok) {
                messageEl.innerText = 'Password changed successfully!';
                messageEl.style.color = 'green';
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                const data = await response.json();
                messageEl.innerText = 'Error: ' + (data.error || data.detail);
                messageEl.style.color = 'red';
            }
        }
    </script>

</body>

</html>